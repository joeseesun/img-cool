"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const B=require("react/jsx-runtime"),K=require("roughjs/bin/rough"),e=require("@plait/core"),O=require("react"),$=require("classnames"),E=require("ahooks"),J=require("react-dom"),G=require("@plait-board/react-text"),M=require("slate-react"),j=require("@plait/common"),Q=(t,a,h)=>{E.useEventListener("pointerdown",n=>{t.pointerDown(n)},{target:h}),E.useEventListener("pointermove",n=>{e.BOARD_TO_MOVING_POINT_IN_BOARD.set(t,[n.x,n.y]),t.pointerMove(n)},{target:a}),E.useEventListener("pointerleave",n=>{e.BOARD_TO_MOVING_POINT_IN_BOARD.delete(t),t.pointerLeave(n)},{target:a}),E.useEventListener("pointerup",n=>{t.pointerUp(n)},{target:a}),E.useEventListener("dblclick",n=>{e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.hasBeenTextEditing(t)&&t.dblClick(n)},{target:h}),E.useEventListener("pointermove",n=>{e.BOARD_TO_MOVING_POINT.set(t,[n.x,n.y]),t.globalPointerMove(n)}),E.useEventListener("pointerup",n=>{t.globalPointerUp(n)}),E.useEventListener("keydown",n=>{t.globalKeyDown(n),e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.hasBeenTextEditing(t)&&!e.hasInputOrTextareaTarget(n.target)&&t.keyDown(n)}),E.useEventListener("keyup",n=>{e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.hasBeenTextEditing(t)&&(t==null||t.keyUp(n))}),E.useEventListener("copy",n=>{e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.hasBeenTextEditing(t)&&(n.preventDefault(),e.setFragment(t,e.WritableClipboardOperationType.copy,n.clipboardData))}),E.useEventListener("paste",async n=>{if(e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.isReadonly(t)&&!e.PlaitBoard.hasBeenTextEditing(t)){const l=e.PlaitBoard.getMovingPointInBoard(t);if(l){const o=e.toViewBoxPoint(t,e.toHostPoint(t,l[0],l[1])),f=await e.getClipboardData(n.clipboardData);t.insertFragment(f,o,e.WritableClipboardOperationType.paste)}}}),E.useEventListener("cut",n=>{e.PlaitBoard.isFocus(t)&&!e.PlaitBoard.isReadonly(t)&&!e.PlaitBoard.hasBeenTextEditing(t)&&(n.preventDefault(),e.setFragment(t,e.WritableClipboardOperationType.cut,n.clipboardData),e.deleteFragment(t))}),E.useEventListener("drop",n=>{e.PlaitBoard.isReadonly(t)||(n.preventDefault(),t.drop(n))},{target:a}),E.useEventListener("dragover",n=>{n.preventDefault()},{target:a})},b=(t,a)=>{E.useEventListener("scroll",n=>{if(e.isFromViewportChange(t))e.setIsFromViewportChange(t,!1);else{const{scrollLeft:l,scrollTop:o}=n.target;e.updateViewportByScrolling(t,l,o)}},{target:a}),E.useEventListener("touchstart",n=>{n.preventDefault()},{target:a,passive:!1}),E.useEventListener("wheel",n=>{if(n.metaKey||n.ctrlKey){n.preventDefault();const{deltaX:l,deltaY:o}=n,f=t.viewport.zoom,s=Math.sign(o),d=e.ZOOM_STEP*100,c=Math.abs(o);let u=o;c>d&&(u=d*s);let p=f-u/100;p+=Math.log10(Math.max(1,f))*-s*Math.min(1,c/20),e.BoardTransforms.updateZoom(t,p,e.PlaitBoard.getMovingPointInBoard(t))}},{target:a,passive:!1});const h=O.useRef(!1);O.useEffect(()=>{const n=new ResizeObserver(()=>{if(!h.current){h.current=!0;return}e.initializeViewportContainer(t),e.initializeViewBox(t),e.updateViewportOffset(t)});return n.observe(e.PlaitBoard.getBoardContainer(t)),()=>{n&&n.disconnect()}},[])},N=O.createContext(null),U=()=>{const t=O.useContext(N);if(!t)throw new Error("The `useBoard` hook must be used inside the <Plait> component's context.");const{board:a}=t;return a},k=()=>{const t=O.useContext(N);if(!t)throw new Error("The `useBoard` hook must be used inside the <Plait> component's context.");const{listRender:a}=t;return a},ee=({style:t,className:a,children:h,afterInit:n})=>{var P,v;const l=O.useRef(null),o=O.useRef(null),f=O.useRef(null),s=O.useRef(null),d=O.useRef(null),c=O.useRef(null),u=O.useRef(null),p=O.useRef(null),r=U(),i=k();return O.useEffect(()=>{const _=K.svg(l.current,{options:{roughness:0,strokeWidth:1}});e.BOARD_TO_ROUGH_SVG.set(r,_),e.BOARD_TO_HOST.set(r,l.current),e.IS_BOARD_ALIVE.set(r,!0),e.BOARD_TO_ELEMENT_HOST.set(r,{lowerHost:o.current,host:f.current,upperHost:s.current,topHost:d.current,activeHost:c.current,container:p.current,viewportContainer:u.current});const w=new e.PlaitBoardContext;return e.BOARD_TO_CONTEXT.set(r,w),e.KEY_TO_ELEMENT_MAP.set(r,new Map),i.initialized||(i.initialize(r.children,{board:r,parent:r,parentG:e.PlaitBoard.getElementHost(r)}),n&&n(r)),e.initializeViewportContainer(r),e.initializeViewBox(r),e.initializeViewportOffset(r),()=>{e.BOARD_TO_CONTEXT.delete(r),e.BOARD_TO_AFTER_CHANGE.delete(r),e.BOARD_TO_ON_CHANGE.delete(r),e.BOARD_TO_ELEMENT_HOST.delete(r),e.IS_BOARD_ALIVE.delete(r),e.BOARD_TO_HOST.delete(r),e.BOARD_TO_ROUGH_SVG.delete(r),e.KEY_TO_ELEMENT_MAP.delete(r)}},[]),Q(r,u,l),b(r,u),B.jsx("div",{className:$(a,e.HOST_CLASS_NAME,`${te()}`,`theme-${(P=r.theme)==null?void 0:P.themeColorMode}`,`pointer-${r.pointer}`,{focused:e.PlaitBoard.isFocus(r),readonly:e.PlaitBoard.isReadonly(r),"disabled-scroll":((v=r.options)==null?void 0:v.disabledScrollOnNonFocus)&&!e.PlaitBoard.isFocus(r)}),ref:p,style:t,children:B.jsxs("div",{className:"viewport-container",ref:u,style:{width:"100%",height:"100%",overflow:"auto"},children:[B.jsxs("svg",{ref:l,width:"100%",height:"100%",style:{position:"relative"},className:"board-host-svg",children:[B.jsx("g",{className:"element-lower-host",ref:o}),B.jsx("g",{className:"element-host",ref:f}),B.jsx("g",{className:"element-upper-host",ref:s}),B.jsx("g",{className:"element-top-host",ref:d})]}),B.jsx("svg",{width:"100%",height:"100%",className:"board-active-svg",children:B.jsx("g",{className:"active-host-g",ref:c})}),h]})})},te=()=>e.IS_SAFARI?"safari":e.IS_CHROME?"chrome":e.IS_FIREFOX?"firefox":"";var A={},q;function ne(){if(q)return A;q=1;var t=J;if(process.env.NODE_ENV==="production")A.createRoot=t.createRoot,A.hydrateRoot=t.hydrateRoot;else{var a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;A.createRoot=function(h,n){a.usingClientEntryPoint=!0;try{return t.createRoot(h,n)}finally{a.usingClientEntryPoint=!1}},A.hydrateRoot=function(h,n,l){a.usingClientEntryPoint=!0;try{return t.hydrateRoot(h,n,l)}finally{a.usingClientEntryPoint=!1}}}return A}var ie=ne();const oe=t=>{const a=t;return a.renderText=(h,n)=>{const l=ie.createRoot(h);let o;const f=B.jsx(G.Text,{...n,afterInit:c=>{o=c,n.afterInit&&n.afterInit(c)}});l.render(f);let s={...n};return{destroy:()=>{setTimeout(()=>{l.unmount()},0)},update:c=>{if(!(c&&s&&!Object.keys(c).every(r=>c[r]===s[r])))return;const p=M.ReactEditor.isReadOnly(o);s={...s,...c},l.render(B.jsx(G.Text,{...s})),p===!0&&s.readonly===!1?setTimeout(()=>{M.ReactEditor.focus(o)},0):p===!1&&s.readonly===!0&&(M.ReactEditor.blur(o),M.ReactEditor.deselect(o))}}},a},re=t=>{const{pointerDown:a,pointerMove:h,pointerUp:n,globalPointerUp:l}=t,o=[];let f=!1;return t.pointerDown=s=>{const d=[s.clientX,s.clientY];o.length<2&&(t.viewport.zoom,o.push({pointerId:s.pointerId,lastPoint:d,currentPoint:d,hasMoved:!1})),a(s)},t.pointerMove=s=>{const d=[s.clientX,s.clientY];if(o.length>=2){const c=o.find(u=>u.pointerId===s.pointerId);if(c&&(c.currentPoint=d,c.hasMoved=!0,o.length===2&&o.every(u=>u.hasMoved))){const[u,p]=o,r=e.getPointBetween(...u.lastPoint,...p.lastPoint),i=e.getPointBetween(...u.currentPoint,...p.currentPoint),P=i[0]-r[0],v=i[1]-r[1],_=e.PlaitBoard.getBoardContainer(t).getBoundingClientRect(),w=_.width/2,T=_.height/2,m=t.viewport.zoom,R=e.getViewportOrigination(t);let g=R[0]+w/m-P/m,I=R[1]+T/m-v/m,D=[g-_.width/2/m,I-_.height/2/m],S=m;const W=e.distanceBetweenPointAndPoint(...u.lastPoint,...p.lastPoint),H=e.distanceBetweenPointAndPoint(...u.currentPoint,...p.currentPoint)/W,x=[u.currentPoint[0]-u.lastPoint[0],u.currentPoint[1]-u.lastPoint[1]],y=[p.currentPoint[0]-p.lastPoint[0],p.currentPoint[1]-p.lastPoint[1]],X=x[0]*y[0]+x[1]*y[1],Y=Math.sqrt(x[0]*x[0]+x[1]*x[1]),Z=Math.sqrt(y[0]*y[0]+y[1]*y[1]),L=X/(Y*Z||1);if(L<-.7||L<=.8&&f&&H>=.01?f=!0:f=!1,f){S=Math.min(Math.max(t.viewport.zoom*H,e.MIN_ZOOM),e.MAX_ZOOM);const F=e.PlaitBoard.getBoardContainer(t).getBoundingClientRect(),V=i[0]-F.x,z=i[1]-F.y;g=D[0]+V/m,I=D[1]+z/m,D=[g-V/S,I-z/S]}e.BoardTransforms.updateViewport(t,D,S),o.forEach(C=>{C.lastPoint=C.currentPoint,C.hasMoved=!1})}return}h(s)},t.pointerUp=s=>{const d=o.findIndex(c=>c.pointerId===s.pointerId);d!==-1&&o.splice(d,1),n(s)},t.globalPointerUp=s=>{const d=o.findIndex(c=>c.pointerId===s.pointerId);d!==-1&&o.splice(d,1),l(s)},t},se=({value:t,children:a,options:h,plugins:n,viewport:l,theme:o,onChange:f,onSelectionChange:s,onValueChange:d,onViewportChange:c,onThemeChange:u})=>{const[p,r]=O.useState(()=>{const w=ae(t,h,n,l,o),T=le(w);return{v:0,board:w,listRender:T}}),{board:i,listRender:P}=p,v=O.useCallback(()=>{if(f){const g={children:i.children,operations:i.operations,viewport:i.viewport,selection:i.selection,theme:i.theme};f(g)}const w=i.operations.some(g=>e.PlaitOperation.isSetSelectionOperation(g)),T=i.operations.some(g=>e.PlaitOperation.isSetViewportOperation(g)),m=i.operations.some(g=>e.PlaitOperation.isSetThemeOperation(g)),R=i.operations.length>0&&!i.operations.every(g=>e.PlaitOperation.isSetSelectionOperation(g)||e.PlaitOperation.isSetViewportOperation(g)||e.PlaitOperation.isSetThemeOperation(g));d&&R&&d(i.children),s&&w&&s(i.selection),c&&T&&c(i.viewport),u&&m&&u(i.theme.themeColorMode),r(g=>({v:g.v+1,board:i,listRender:P}))},[i,f,s,d]);O.useEffect(()=>(e.BOARD_TO_ON_CHANGE.set(i,()=>{if(i.operations.length&&i.operations.every(R=>R.type==="set_selection")){P.update(i.children,{board:i,parent:i,parentG:e.PlaitBoard.getElementHost(i)});return}const T=i.operations.length&&i.operations.some(R=>R.type==="set_viewport");if(T&&e.isFromScrolling(i)){e.setIsFromScrolling(i,!1),P.update(i.children,{board:i,parent:i,parentG:e.PlaitBoard.getElementHost(i)});return}P.update(i.children,{board:i,parent:i,parentG:e.PlaitBoard.getElementHost(i)}),T?e.initializeViewBox(i):e.updateViewBox(i),e.updateViewportOffset(i),e.getSelectedElements(i).forEach(R=>{e.PlaitElement.getElementRef(R).updateActiveSection()})}),e.BOARD_TO_AFTER_CHANGE.set(i,()=>{v()}),()=>{e.BOARD_TO_ON_CHANGE.delete(i),e.BOARD_TO_AFTER_CHANGE.delete(i)}),[i]);const _=O.useRef(!0);return O.useEffect(()=>{if(_.current){_.current=!1;return}t!==p.board.children&&!e.FLUSHING.get(i)&&(i.children=t,P.update(i.children,{board:i,parent:i,parentG:e.PlaitBoard.getElementHost(i)}),e.BoardTransforms.fitViewport(i))},[t]),B.jsx(N.Provider,{value:p,children:a})},ae=(t,a,h,n,l)=>{let o=e.withRelatedFragment(e.withHotkey(e.withHandPointer(e.withHistory(e.withSelection(e.withMoving(e.withBoard(e.withI18n(e.withOptions(oe(j.withImage(j.withText(e.createBoard(t,a)))))))))))));return h.forEach(f=>{o=f(o)}),re(o),n&&(o.viewport=n),l&&(o.theme=l),o},le=t=>new e.ListRender(t);exports.Board=ee;exports.BoardContext=N;exports.Wrapper=se;exports.useBoard=U;exports.useListRender=k;
